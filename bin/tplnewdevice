#!/bin/bash

if [ "$1" == "" ]; then
    echo "Missing SSID argument."
    exit
fi

TGRBIN="/home/pi/tgr/bin"
TGRAPI="http://localhost:8080/api"
TGRPSK="Th3Gr33nR00m"

OUTFILE="/tmp/tplnewdevice.out"

SYS_PROPS=`curl -s "${TGRAPI}/system/status?show=all"`
SSID=`echo $SYS_PROPS | awk -F"[,:}]" '{for(i=1;i<=NF;i++){if($i~/'ssid'\042/){print $(i+1)}}}' | tr -d '"' | sed -n 2p | awk '{ print $1 }'`

CURRENT_ID=`wpa_cli -iwlan0 list_networks | grep CURRENT | awk '{ print $1 }'`
NEW_ID=`wpa_cli -iwlan0 add_network`
wpa_cli -iwlan0 set_network $NEW_ID ssid '"'$1'"' >> $OUTFILE 2>&1
wpa_cli -iwlan0 set_network $NEW_ID key_mgmt NONE >> $OUTFILE 2>&1
wpa_cli -iwlan0 enable_network $NEW_ID >> $OUTFILE 2>&1
wpa_cli -iwlan0 select_network $NEW_ID >> $OUTFILE 2>&1

sleep 20

$TGRBIN/tplink_smartplug.py -t 192.168.0.1 -j '{"cnCloud":{"set_server_url":{"server":"tplconnect"}}}' >> $OUTFILE 2>&1
$TGRBIN/tplink_smartplug.py -t 192.168.0.1 -j '{"netif":{"set_stainfo":{"ssid":"'${SSID}'","password":"'${TGRPSK}'","key_type":2}}}' >> $OUTFILE 2>&1

wpa_cli -iwlan0 enable_network $CURRENT_ID >> $OUTFILE 2>&1
wpa_cli -iwlan0 select_network $CURRENT_ID >> $OUTFILE 2>&1
wpa_cli -iwlan0 remove_network $NEW_ID >> $OUTFILE 2>&1

grep Received $OUTFILE | tail -1 | awk -F"[,:}]" '{for(i=1;i<=NF;i++){if($i~/'err_code'\042/){print $(i+1)}}}' | tr -d '"'
